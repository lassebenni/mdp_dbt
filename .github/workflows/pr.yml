name: "Pull Request"
on:
  pull_request:

jobs:
  dbt:
    name: "Run dbt"
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: "Checkout"
        uses: actions/checkout@master
      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with:
          workload_identity_provider: "projects/303639907957/locations/global/workloadIdentityPools/identity-pool/providers/github"
          service_account: "bigquery@analytics-engineers.iam.gserviceaccount.com"
      - name: dbt-action
        id: dbt-build
        uses: mwhitaker/dbt-action@master
        with:
          dbt_command: "dbt build --profiles-dir ."
      - name: Get log results
        if: ${{ always() }}
        id: log
        run: echo ::set-output name=body::$(cat ./logs/dbt.log )
      - name: Comment results in PR
        if: ${{ always() }}
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            echo ${{ steps.log.outputs.body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

