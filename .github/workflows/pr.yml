name: "Pull Request"
on:
  pull_request:

jobs:
  dbt:
    name: "Run dbt"
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: "Checkout"
        uses: actions/checkout@master
      - id: "auth"
        uses: "google-github-actions/auth@v0"
        with:
          workload_identity_provider: "projects/303639907957/locations/global/workloadIdentityPools/identity-pool/providers/github"
          service_account: "bigquery@analytics-engineers.iam.gserviceaccount.com"
      - name: dbt-action
        id: dbt-build
        uses: mwhitaker/dbt-action@master
        with:
          dbt_command: "dbt build --profiles-dir ."
      - name: Pretty the log results
        if: ${{ always() }}
        id: pretty_log
        run: python utils/clean_dbt_log.py
      - name: Cat the pretty log
        if: ${{ always() }}
        id: cat
        run: cat ./dbt.log
      - name: Get log results
        if: ${{ always() }}
        id: log
        run: echo ::set-output name=body::$(cat ./dbt.log )
      - name: Comment results in PR
        uses: actions/github-script@v6
        if: ${{ always() }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Testing the comment'
            })
